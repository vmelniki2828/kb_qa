# Система обработки токенов

## Проблема
Токен аутентификации истекает через 14 дней, после чего пользователь получает 401 ошибку при попытке доступа к защищенным страницам.

## Решение

### 1. Автоматическая проверка токена
- При каждом переходе на защищенную страницу токен проверяется на сервере
- Если токен невалиден, пользователь автоматически перенаправляется на страницу логина

### 2. Обработка 401 ошибок
- Все API запросы автоматически обрабатывают 401 ошибки
- При получении 401 ошибки токены очищаются из localStorage
- Пользователь перенаправляется на страницу логина

### 3. Уведомления пользователя
- На странице логина показывается сообщение об истечении сессии
- Создан компонент `TokenExpiredNotification` для отображения уведомлений

## Компоненты

### `src/utils/auth.js`
Утилиты для работы с аутентификацией:
- `checkTokenValidity()` - проверяет валидность токена на сервере
- `handleApiError()` - обрабатывает 401 ошибки
- `getAuthHeaders()` - возвращает заголовки для API запросов

### `src/hooks/useApi.js`
Хук для работы с API:
- Автоматически добавляет заголовки авторизации
- Обрабатывает 401 ошибки
- Перенаправляет на логин при необходимости

### `src/components/App.jsx`
Обновленный компонент `RequireAuth`:
- Проверяет валидность токена при каждом переходе
- Показывает индикатор загрузки во время проверки
- Перенаправляет на логин при невалидном токене

### `src/components/login/LoginForm.jsx`
Обновленная форма логина:
- Показывает сообщение об истечении сессии
- Очищает старые токены при загрузке
- Обрабатывает состояние перенаправления

## Использование

### Для новых API запросов:
```javascript
import { useApi } from '../hooks/useApi';

const MyComponent = () => {
  const { apiRequest } = useApi();

  const fetchData = async () => {
    try {
      const response = await apiRequest('https://api.example.com/data', {
        method: 'GET'
      });
      const data = await response.json();
      // Обработка данных
    } catch (error) {
      // Ошибка уже обработана в useApi
      console.error('Ошибка:', error);
    }
  };
};
```

### Для существующих компонентов:
Замените прямые fetch запросы на использование `apiRequest`:

```javascript
// Было:
const response = await fetch(url, {
  method: 'GET',
  headers: {
    'Authorization': `Bearer ${access}`,
    'Content-Type': 'application/json',
  },
});

// Стало:
const response = await apiRequest(url, {
  method: 'GET'
});
```

## Преимущества

1. **Автоматическая обработка**: 401 ошибки обрабатываются автоматически
2. **Улучшенный UX**: Пользователь видит понятные сообщения об истечении сессии
3. **Безопасность**: Невалидные токены автоматически очищаются
4. **Централизованная логика**: Вся логика работы с токенами в одном месте
5. **Простота использования**: Минимальные изменения в существующем коде

## Миграция

Для миграции существующих компонентов:

1. Импортируйте `useApi` хук
2. Замените `fetch` на `apiRequest`
3. Удалите ручную обработку токенов и заголовков
4. Удалите ручную обработку 401 ошибок

Пример миграции компонента:
```javascript
// До:
const tokens = localStorage.getItem('tokens');
const { access } = JSON.parse(tokens);
const response = await fetch(url, {
  headers: {
    'Authorization': `Bearer ${access}`,
    'Content-Type': 'application/json',
  },
});

// После:
const { apiRequest } = useApi();
const response = await apiRequest(url, {
  method: 'GET'
});
``` 